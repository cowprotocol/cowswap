


import{a1 as E,r as m,x as i,o as A,cP as He,cO as qe,g as h,ay as Qe,S as me,aq as Ge,v as Ke,aI as ze,cS as Xe,cT as G,cU as Ye,cE as K,an as Ze,Z as $e,Y as Je,cr as et}from"./vendor-35db3a09.js";import{aH as _,n as tt,aI as fe,aJ as nt,aK as rt,F as M,p as at,ao as st,ap as ot,aL as Ae,aM as it,aq as ut,ar as ct,at as dt,a as z,av as X,aN as Te,aw as lt,aO as pt,aP as mt,aQ as ft,e as C,aR as At,aS as oe,aT as Tt,aU as St,aV as Se,t as bt,aW as ie,aX as Ot,aY as Y,aZ as U,a_ as xt,V as gt,X as Pt,a$ as Ct,b0 as wt,b1 as be,a9 as yt,D as ht,b2 as Oe,b3 as Et,q as It,r as Dt,b4 as vt,b5 as Ft,b6 as Lt,b7 as Rt,b8 as jt,b9 as _t,ba as kt,aa as Ut,s as Mt,bb as Wt,L as Nt,x as B,bc as P,bd as xe,be as Bt,bf as Vt,bg as Ht,bh as qt,ak as ge,N as Qt,bi as Gt,bj as Kt,d as Pe,o as zt,bk as Xt,bl as Yt,bm as ue,bn as Zt,bo as $t,bp as Jt,bq as D,br as en,bs as ce,bt as tn,bu as Z,bv as $,bw as Ce,bx as J,by as nn,bz as we,bA as ye,aE as rn,bB as an,bC as sn,bD as on,bE as un,bF as cn,bG as dn,bH as he,ax as ln,az as pn,aC as de,aB as mn,aD as fn,bI as An,bJ as Tn,bK as Sn,bL as bn,bM as On,bN as xn,bO as gn,bP as Pn,a8 as Cn,bQ as wn,aG as yn,bR as hn,bS as En,bT as In,bU as Dn,bV as vn,c as V}from"./index-a8951d67.js";import{u as Fn,S as Ln,U as Rn,r as jn,t as ee,p as W,i as Ee,j as te,k as _n,W as kn,l as Un,L as Mn,A as Wn,F as Nn,m as Ie,n as ne,o as De,b as re,q as Bn,s as N,C as ve,v as Vn,w as Hn,R as qn,x as Qn,y as ae,T as Gn,d as Kn,z as zn,B as Fe,D as Xn,E as Yn,G as Zn,H as $n,I as Le,J as H,K as q,M as Jn,N as v,Q as le,V as er,X as tr,Y as nr,Z as rr,_ as ar,$ as sr,a0 as or,a1 as ir,e as ur,P as cr,f as dr,g as lr,O as pr,h as mr}from"./index-a69a2960.js";function Re(){const{inputCurrency:e}=_(),t=tt(),n=fe(),r=E(nt),a=rt(),s=m.useCallback((l,p)=>{n({amount:{isTyped:!1,value:""},field:M.OUTPUT,currency:p}),t(l,p),r({response:null})},[t,n,r]),o=m.useCallback((l,p)=>{at(l,Number(p)),n({amount:{isTyped:!0,value:p},currency:e,field:l})},[e,n]),u=m.useCallback(l=>{a({recipient:l})},[a]),c=Fn({outputCurrencyAmount:null}),d=m.useCallback(()=>{c(),r({response:null})},[r,c]);return{onCurrencySelection:s,onUserInput:o,onChangeRecipient:u,onSwitchTokens:d}}function fr({state:e,onStateChanged:t}){const{showRecipient:n}=e;return i.jsxs(st,{children:[i.jsx(ot,{children:"Interface Settings"}),i.jsx(Ln,{title:"Custom Recipient",tooltip:"Allows you to choose a destination address for the swap other than the connected one.",value:n,toggle:()=>t({showRecipient:!n})})]})}function Ar(){const e=A(Ae),t=E(it),n=m.useCallback(r=>{t(r)},[t]);return i.jsxs(He,{children:[i.jsx(ut,{children:i.jsx(ct,{})}),i.jsx(dt,{children:i.jsx(qe,{disabled:!0,onSelect:()=>{},children:i.jsx(fr,{state:e,onStateChanged:n})})})]})}const Tr=[{content:"Get the Time-Weighted Average Price by splitting your large order into parts"},{content:"Customize your order size, expiration, and number of parts"},{content:"Always receive 100% of your order surplus"},{content:"Reduce your slippage by breaking big orders into smaller ones"}],k={title:"Unlock the Power of TWAP Orders",subtitle:"Begin with TWAP Today!",orderType:"TWAP",buttonText:"Unlock TWAP orders (BETA)",buttonLink:pt};function Sr({children:e,updaters:t,params:n}){const{disablePriceImpact:r}=n,{inputCurrency:a,outputCurrency:s,inputCurrencyAmount:o,outputCurrencyAmount:u,inputCurrencyBalance:c,outputCurrencyBalance:d,inputCurrencyFiatAmount:l,outputCurrencyFiatAmount:p,recipient:f,orderKind:T,isUnlocked:O}=_(),x=Re(),{isLoading:b}=z(),{showRecipient:S}=A(Ae),w=X(),I=E(Te),y={field:M.INPUT,currency:a,amount:o,isIndependent:T===h.OrderKind.SELL,receiveAmountInfo:null,balance:c,fiatAmount:l},g={field:M.OUTPUT,currency:s,amount:u,isIndependent:T===h.OrderKind.BUY,receiveAmountInfo:null,balance:d,fiatAmount:p},F={settingsWidget:i.jsx(Ar,{}),bottomContent:e,updaters:t,lockScreen:O?void 0:i.jsx(Rn,{id:"advanced-orders",items:Tr,buttonLink:k.buttonLink,title:k.title,subtitle:k.subtitle,orderType:k.orderType,buttonText:k.buttonText,handleUnlock:()=>I({isUnlocked:!0})})},L={recipient:f,compactView:!0,disableNativeSelling:!0,showRecipient:S,isTradePriceUpdating:b,priceImpact:w,isExpertMode:!1,disablePriceImpact:r};return i.jsx(i.Fragment,{children:i.jsx(lt,{id:"advanced-orders-page",disableOutput:!0,slots:F,actions:x,params:L,inputCurrencyInfo:y,outputCurrencyInfo:g})})}function br(){return mt(),null}function Or(){return A(ft)}function xr(){const{chainId:e}=C(),t=At(),n=Or(),{data:r=[]}=Qe(["prod-orders",t,e],()=>!e||!t?[]:oe?Tt(t,{chainId:e,env:"prod"}):[],{refreshInterval:St});return m.useMemo(()=>oe?r:n,[n,r])}function gr(e,t){const n=t?e.invert():e;return me.fromRawAmount(n.baseCurrency,jn(1,n.baseCurrency.decimals))}function Pr(e,t){const n=e?gr(e,t):void 0;return Se(n).value}function je({executionPrice:e,isInverted:t,showBaseCurrency:n,separatorSymbol:r="≈",hideSeparator:a,hideFiat:s}){const o=Pr(s?null:e,t),u=t?e?.baseCurrency:e?.quoteCurrency,c=t?e?.quoteCurrency:e?.baseCurrency,d=bt("1",c);return i.jsxs("span",{children:[n&&i.jsx(ie,{amount:d,tokenSymbol:c}),!a&&` ${r} `,i.jsx(ie,{amount:t?e.invert():e,tokenSymbol:u}),o&&i.jsxs("i",{children:[" (",i.jsx(Ot,{accurate:!0,amount:o}),")"]})]})}function se(){const{chainId:e}=C(),t=A(ee),{inputFiatAmount:n}=A(W),r=A(Ee),a=te(),s=Y();return m.useMemo(()=>_n({isSafeApp:s,verification:a,twapOrder:t,sellAmountPartFiat:n,chainId:e,partTime:r}),[s,a,t,n,e,r])}function pe(e){const{amount:t,fiatAmount:n,label:r,tooltip:a}=e;return i.jsxs(Un,{children:[i.jsxs(Mn,{children:[i.jsx(Ge,{id:"w9dLMW",values:{label:r}}),i.jsx(xt,{text:a})]}),i.jsx(Wn,{amount:t,tokenSymbol:t?.currency}),i.jsx(Nn,{amount:n})]})}function Cr({partsState:e,labels:t}){const{numberOfPartsValue:n,inputPartAmount:r,outputPartAmount:a,inputFiatAmount:s,outputFiatAmount:o}=e,{sellAmount:u,buyAmount:c}=t;return i.jsxs(kn,{children:[i.jsx(pe,{label:i.jsxs(i.Fragment,{children:[t.sellAmount.label," (1/",n,")"]}),tooltip:U(u.tooltip),amount:r,fiatAmount:s}),i.jsx(pe,{label:i.jsxs(i.Fragment,{children:[c.label," (1/",n,")"]}),tooltip:U(c.tooltip),amount:a,fiatAmount:o})]})}function wr(){const{isPriceImpactAccepted:e,isFallbackHandlerSetupAccepted:t}=A(Ie),{showPriceImpactWarning:n}=ne(),r=De();return n?e:r?t:!0}function yr({localFormValidation:e,primaryFormValidation:t,fallbackHandlerIsNotSet:n}){const r=re(),{walletIsNotConnected:a}=ne(),s=()=>{r.onOpen(),N("initiated",n)},o=wr(),u={confirmTrade:s},c=gt("TWAP order",{doTrade:s,confirmTrade:s});return c?e&&!a?i.jsx(Bn,{state:e,context:u}):i.jsx(Pt,{doTradeText:"Place TWAP order",confirmText:"Review TWAP order",validation:t,context:c,isExpertMode:!1,isDisabled:!o}):null}function hr(e){const{price:t,isInvertedState:n,limitPriceLabel:r="Limit price",limitPriceTooltip:a="The limit price"}=e,[s,o]=n;return i.jsx(Ct,{onClick:()=>o(u=>!u),children:i.jsx(ve,{label:r,tooltip:a,children:t?i.jsx(je,{executionPrice:t,isInverted:s,showBaseCurrency:!0,separatorSymbol:"="}):"-"})})}function Er({slippage:e,slippageLabel:t,slippageTooltip:n}){return i.jsx(ve,{children:i.jsx(wt,{allowedSlippage:e,showSettingOnClick:!1,slippageLabel:t,slippageTooltip:n})})}function Ir(e){const{rateInfoParams:t,minReceiveAmount:n,isInvertedState:r,slippage:a,additionalProps:s}=e,{inputCurrencyAmount:o}=t,u=s?.priceLabel||"Price",c=s?.minReceivedLabel||"Min received (incl. fee)",d=s?.minReceivedTooltip||"This is the minimum amount that you will receive.",l=Se(n).value,p=be(o,n);return i.jsxs(Vn,{children:[i.jsx(Hn,{label:u,stylized:!0,rateInfoParams:t,isInvertedState:r}),i.jsx(Er,{slippage:a,...s}),i.jsx(hr,{price:p,isInvertedState:r,...s}),i.jsx(qn,{amount:n,fiatAmount:l,tooltip:d,label:c})]})}function _e(){const{chainId:e,account:t}=C(),n=yt(),{provider:r}=Ke.useWeb3React();return!t||!n||!r||!e?null:{settlementContract:n,provider:r,chainId:e,safeAddress:t}}function Dr(e,t,n){const[r,a]=m.useState(!1);return m.useEffect(()=>{!e||!t||!n||ht({tokenContract:e,spender:t,amountToApprove:n,isBundle:!0}).then(a)},[e?.address,n?.quotient?.toString(),t]),r}function vr(e){const{chainId:t}=C(),n=Oe(),r=Et(e),a=It(e?.currency.address),s=Dt(),o=Dr(a,s,e),u=t?vt[t]:null;return!n||!a||!s||!u?null:{composableCowContract:n,erc20Contract:a,needsApproval:r,needsZeroApproval:o,spender:s,currentBlockFactoryAddress:u}}function Fr(e,t,n){const{composableCowContract:r,needsApproval:a,needsZeroApproval:s,erc20Contract:o,spender:u,currentBlockFactoryAddress:c}=n,{sellAmount:d}=e,l=d.currency.address,p=d.quotient.toString(),f=[],T={to:r.address,data:r.interface.encodeFunctionData("createWithContext",[t,c,"0x",!0]),value:"0",operation:0};if(f.push(T),!a)return f;const O={to:l,data:o.interface.encodeFunctionData("approve",[u,p]),value:"0",operation:0};if(f.unshift(O),!s)return f;const x={to:d.currency.address,data:o.interface.encodeFunctionData("approve",[u,"0"]),value:"0",operation:0};return f.unshift(x),f}async function Lr(e){const{chainId:t,safeAddress:n,settlementContract:r}=e,a=await r.callStatic.domainSeparator(),s=await Qn(e),o=Ft[t],u=Lt[t],c={to:n,data:s.interface.encodeFunctionData("setFallbackHandler",[u]),value:"0",operation:0},d={to:n,data:s.interface.encodeFunctionData("setDomainVerifier",[a,o]),value:"0",operation:0};return[c,d]}function ke(e){const t=e.buyAmount.currency;return{sellToken:e.sellAmount.currency.address,buyToken:t.isNative?Rt:t.address,receiver:e.receiver,partSellAmount:e.sellAmount.divide(e.numOfParts).quotient.toString(),minPartLimit:e.buyAmount.divide(e.numOfParts).quotient.toString(),t0:e.startTime,n:e.numOfParts,t:e.timeInterval,span:e.span,appData:e.appData}}function Rr(e,t){const n=ke(t);return{handler:jt[e],salt:ze(Xe.Buffer.from(Date.now().toString(16),"hex"),32),staticInput:G.encode([_t],[n])}}const jr="tuple(address handler, bytes32 salt, bytes staticInput)";function Ue(e){return Ye(G.encode([jr],[e]))}const _r="Something went wrong creating your order";function kr(e){if(e&&e.message&&e.message.includes("INVALID_ARGUMENT")){const t=e.message.match(/argument="([^"]+)"/),n=t?.length?t[1]:"";if(n)return`Invalid argument "${n}" provided`}}function Ur(e){return kr(e)||e.message||_r}function Mr(){const{chainId:e,account:t}=C(),n=A(ee),r=E(kt),{inputCurrencyAmount:a,outputCurrencyAmount:s,recipient:o}=_(),u=Ut(),c=Mt(),d=vr(a),l=_e(),p=E(Te),f=re(),T=Wt(),{priceImpact:O}=X(),{confirmPriceImpactWithoutFee:x}=Nt();return m.useCallback(async b=>{if(!e||!t||!a||!s||!d||!l||!c||!u||!n||!await x(O))return;const w={inputAmount:a,outputAmount:s},I={account:t,recipient:n.receiver,recipientAddress:n.receiver,marketLabel:[a.currency.symbol,s.currency.symbol].join(","),orderClass:"TWAP"};try{const y=Rr(e,n),g=Ue(y);f.onSign(w),B.placeAdvancedOrder(I),N("posted",b);const F=b?await Lr(l):[],L=Fr(n,y,d),{safeTxHash:j}=await c.txs.send({txs:[...F,...L]}),R={order:ke(n),status:P.WaitSigning,chainId:e,safeAddress:t,submissionDate:new Date().toISOString(),id:g,executionInfo:{confirmedPartsCount:0,info:xe}};r(R);const Ve=Bt({recipient:o||t,kind:h.OrderKind.SELL,recipientAddressOrName:o||t,account:t,inputAmount:n.sellAmount,outputAmount:n.buyAmount,feeAmount:void 0});Vt().play(),Ht(qt,j,Ve,h.OrderClass.LIMIT,"composable-order"),T({chainId:e,orderId:g,appData:u}),p({recipient:null,recipientAddress:null}),f.onSuccess(j),B.sign(I),N("signed",b)}catch(y){console.error("[useCreateTwapOrder] error",y);const g=Ur(y);f.onError(g),B.error(y,g,I),N("rejected",b)}},[e,t,a,s,d,l,c,u,n,x,O,T,f,r,o,p])}function Wr({fallbackHandlerIsNotSet:e}){const{inputCurrencyAmount:t,inputCurrencyFiatAmount:n,inputCurrencyBalance:r,outputCurrencyAmount:a,outputCurrencyFiatAmount:s,outputCurrencyBalance:o}=_(),u=A(ee),c=A(ae),d=A(W),{showPriceImpactWarning:l}=ne(),p=se(),f=re(),T=Mr(),O=m.useState(!1),x=!!p,b=X(),S={amount:t,fiatAmount:n,balance:r,label:"Sell amount"},w={amount:a,fiatAmount:s,balance:o,label:"Estimated receive amount"},I=ge(S.amount,w.amount),y=u?.buyAmount,{timeInterval:g,numOfParts:F}=u||{},L=g,j=g&&F?g*F:void 0;return i.jsx(Gn,{children:i.jsx(Kn,{title:"Review TWAP order",inputCurrencyInfo:S,outputCurrencyInfo:w,onConfirm:()=>T(e),onDismiss:f.onDismiss,isConfirmDisabled:x,priceImpact:b,buttonText:"Place TWAP order",children:i.jsxs(i.Fragment,{children:[i.jsx(Ir,{rateInfoParams:I,minReceiveAmount:y,isInvertedState:O,slippage:c,additionalProps:{priceLabel:"Price (incl. fee)",slippageLabel:"Price protection",slippageTooltip:i.jsxs(i.Fragment,{children:[i.jsx("p",{children:"Since TWAP orders consist of multiple parts, prices are expected to fluctuate. However, to protect you against bad prices, CoW Swap will not execute your TWAP if the price dips below this percentage."}),i.jsx("p",{children:"This percentage only applies to dips; if prices are better than this percentage, CoW Swap will still execute your order."})]}),limitPriceLabel:"Limit price",limitPriceTooltip:i.jsxs(i.Fragment,{children:["If CoW Swap cannot get this price or better (taking into account fees and price protection tolerance), your TWAP will not execute. CoW Swap will ",i.jsx("strong",{children:"always"})," improve on this price if possible."]}),minReceivedLabel:"Min received",minReceivedTooltip:"This is the minimum amount that you will receive across your entire TWAP order, assuming all parts of the order execute."}}),i.jsx(zn,{startTime:u?.startTime,partDuration:L,partsState:d,totalDuration:j}),l&&i.jsx(Qt,{withoutAccepting:!0,isAccepted:!0}),i.jsx(Fe,{localFormValidation:p,isConfirmationModal:!0})]})})})}function Nr(){const{account:e}=C(),{numberOfPartsValue:t,deadline:n,customDeadline:r,isCustomDeadline:a}=A(Ie),s=A(Xn),{inputCurrencyAmount:o,outputCurrencyAmount:u}=_(),{inputCurrencyAmount:c}=Gt(),{updateState:d}=Kt(),l=De(),p=Yn(),f=te(),T=A(ae),O=A(W),x=A(Ee),b=E(Zn),S=se(),w=Pe(),I=zt(),y=ge(o,u),g=be(o,s),F={deadline:n,customDeadline:r,isCustomDeadline:a};m.useEffect(()=>{d?.({outputCurrencyAmount:null})},[d,t,c]),m.useEffect(()=>{b({isFallbackHandlerSetupAccepted:!1,isPriceImpactAccepted:!1}),$n()},[]),m.useEffect(()=>{e&&f&&(S===Le.NOT_SAFE?H("non-compatible"):l?H("safe-that-could-be-converted"):p&&H("compatible"))},[e,l,p,S,f]);const L=m.useState(!1),[j]=L;return i.jsxs(i.Fragment,{children:[i.jsx(Wr,{fallbackHandlerIsNotSet:l}),!I&&i.jsx(q,{children:i.jsx(Jn,{label:v.price.label,rateInfoParams:y,isInvertedState:L})}),i.jsx(le,{value:+T.toFixed(2),onUserInput:R=>b({slippageValue:R}),decimalsPlaces:2,placeholder:Xt.toFixed(1),min:0,max:Yt,label:v.slippage.label,tooltip:U(v.slippage.tooltip),showUpDownArrows:!0,upDownArrowsLeftAlign:!0,prefixComponent:i.jsx("em",{children:g?i.jsx(je,{executionPrice:g,isInverted:j,hideFiat:!0,hideSeparator:!0}):"0"}),suffix:"%",step:.1}),i.jsx(q,{children:i.jsx(le,{value:t,onUserInput:R=>{b({numberOfPartsValue:R||ue})},min:ue,label:v.numberOfParts.label,tooltip:U(v.numberOfParts.tooltip),showUpDownArrows:!0})}),i.jsxs(q,{children:[i.jsx(er,{deadline:F,items:Zt,setDeadline:R=>b(R),label:v.totalDuration.label,tooltip:U(v.totalDuration.tooltip,{parts:t,partDuration:x})}),i.jsx(tr,{label:v.partDuration.label,tooltip:v.partDuration.tooltip,children:i.jsx(i.Fragment,{children:nr(x)})})]}),i.jsx(Cr,{partsState:O,labels:rr}),i.jsx(Fe,{localFormValidation:S}),i.jsx(yr,{fallbackHandlerIsNotSet:l,localFormValidation:S,primaryFormValidation:w})]})}function Br(e,t){const n=new Date((e.order.validTo-t.order.t)*1e3),r=t.status===P.Cancelling;return{...e.order,creationDate:n.toISOString(),class:h.OrderClass.LIMIT,status:Vr(t),owner:t.safeAddress.toLowerCase(),uid:e.uid,signingScheme:h.SigningScheme.EIP1271,signature:"",appData:t.order.appData,totalFee:"0",feeAmount:"0",executedSellAmount:"0",executedSellAmountBeforeFees:"0",executedBuyAmount:"0",executedFeeAmount:"0",invalidated:r}}function Vr(e){return e.status===P.Fulfilled?h.OrderStatus.FULFILLED:e.status===P.Expired?h.OrderStatus.EXPIRED:e.status===P.Cancelled?h.OrderStatus.CANCELLED:h.OrderStatus.OPEN}function Hr(e,t){if(!t.executedDate)return!1;const n=new Date(t.executedDate),r=Math.ceil(n.getTime()/1e3)+t.order.t*t.order.n;return e.order.validTo+1>=r}function qr(e,t,n){const r=$t(e,0),a=Jt(e);return t.status===P.Fulfilled?D.FULFILLED:en(e)?D.FULFILLED:t.status===P.Cancelled?r&&!a?D.EXPIRED:D.CANCELLED:a?D.CANCELLED:t.status===P.Expired?D.EXPIRED:r?D.EXPIRED:n?D.SCHEDULED:D.PENDING}function Me(e,t,n,r,a){const s=e.chainId,o=e.isCancelling||r.status===P.Cancelling,u=qr(t,r,n),c={...t,id:t.uid,composableCowInfo:{isVirtualPart:n,isTheLastPart:Hr(e,r),parentId:r.id},sellAmountBeforeFee:t.sellAmount,inputToken:ce(s,t.sellToken,a),outputToken:ce(s,t.buyToken,a),creationTime:t.creationDate,summary:"",status:u,apiAdditionalInfo:t,isCancelling:o},d=tn({orderFromStore:c,orderFromApi:t});return c.summary=d||"",c}const Qr=5e3;function Gr(e){const t=A(Z),n=A($),r=Ce(Qr);return m.useMemo(()=>r?e?Kr(n,t,e):[]:[],[n,t,e,r])}function Kr(e,t,n){return e.reduce((r,a)=>{if(a.isCreatedInOrderBook)return r;const s=!0,o=t[a.twapOrderId];if(!o)return r;const u=Br(a,o),c=Me(a,u,s,o,n);return r.push(c),r},[])}const zr=5e3;function Xr(e){const{account:t,chainId:n}=C(),r=A(J),a=Ce(zr),s=t?.toLowerCase();return m.useMemo(()=>a?e?r.filter(o=>o.chainId===n&&o.safeAddress.toLowerCase()===s).map(o=>nn(o,e)):[]:[],[r,s,n,e,a])}function Yr(){const e=A(J),t=A($),n=we(),r=m.useMemo(()=>ye([...e,...t]),[e,t]);return K(()=>n(r),[n,r])}function Zr(){const{chainId:e,account:t}=C(),n=Yr(),r=Xr(n),a=Gr(n),s=Y(),o=rn(e,t,h.OrderClass.LIMIT),u=m.useMemo(()=>o.filter(d=>d.composableCowInfo?.isVirtualPart===!1),[o]);return m.useMemo(()=>s?r.concat(a).concat(u):[],[r,a,u,s])}const $r=!1;function Jr(){const{chainId:e}=C(),t=xr(),n=we(),r=A($),a=A(Z),s=E(an),o=sn(),u=m.useMemo(()=>r.reduce((d,l)=>(d[l.uid]=l,d),{}),[r]),c=K(async()=>{const d=t.reduce((p,f)=>{const T=u[f.uid],O=a[T?.twapOrderId];return O&&p.push({item:T,parent:O,order:f}),p},[]),l=await n(ye(d));return d.map(({item:p,parent:f,order:T})=>Me(p,T,$r,f,l))},[t,u,n,a],[]);return m.useEffect(()=>{if(!c.length)return;const d=c.reduce((l,p)=>(l[p.id]={isCreatedInOrderBook:!0},l),{});s(d),o({orders:c,chainId:e})},[e,c,o,s]),null}function ea(){const{account:e}=C(),t=E(ar),r=te()!==sr.HAS_DOMAIN_VERIFIER,a=_e(),s=K(()=>a&&r?or(a):null,[r,a],null);return m.useEffect(()=>{!e||s===null||t({[e]:s})},[s,t,e]),null}const ta=un(cn);function na(){const{inputCurrencyAmount:e}=_(),{response:t,error:n,isLoading:r}=z(),a=e?.quotient.toString()||null,s=t?.quote.buyAmount,o=on(a),u=E(ir);return m.useEffect(()=>{n||r||!s||!o||ta(o).then(c=>{const{cancelled:d,data:l}=c;d||u(l)})},[s,r,n,o,u]),null}async function ra(e,t,n){const{computeOrderUid:r}=await Ze(()=>import("./vendor-35db3a09.js").then(s=>s.d6),["assets/vendor-35db3a09.js","assets/vendor-a3fc99cd.css"]),a=await h.OrderSigningUtils.getDomain(e);return r(a,n,t)}function aa(){const{chainId:e,account:t}=C(),n=A(J),r=E(dn);return m.useEffect(()=>{if(!e||!t)return;const a=t.toLowerCase(),s=n.map(o=>sa(o,a,e));Promise.all(s).then(o=>{const u=o.reduce((c,d)=>({...c,...d}),{});r(u)})},[e,t,n,r]),null}async function sa(e,t,n){const r=e.id,a=[...new Array(e.order.n)].map((o,u)=>oa(e,u)).filter(he),s=await Promise.all(a.map(o=>ra(n,t,o)));return{[r]:s.map((o,u)=>({uid:o,index:u,twapOrderId:r,chainId:n,safeAddress:t,isCreatedInOrderBook:!1,isCancelling:!1,order:a[u]}))}}function oa(e,t){const n=e.safeTxParams?.executionDate;if(!n)return null;const r=new Date(n);return{sellToken:e.order.sellToken,buyToken:e.order.buyToken,receiver:e.order.receiver,sellAmount:e.order.partSellAmount,buyAmount:e.order.minPartLimit,validTo:ia({part:t,startTime:Math.ceil(r.getTime()/1e3),span:e.order.span,frequency:e.order.t}),appData:e.order.appData,feeAmount:"0",kind:"sell",partiallyFillable:!1,sellTokenBalance:"erc20",buyTokenBalance:"erc20"}}function ia({part:e,startTime:t,frequency:n,span:r}){return r===0?t+(e+1)*n-1:t+e*n+r-1}function ua(){const{state:e}=ln(),{response:t,isLoading:n}=z(),{numberOfPartsValue:r}=A(W),a=pn(r),s=fe(),o=e?.outputCurrency,u=m.useMemo(()=>{const c=r!==a;if(!t||!o||!r||n||c)return null;const{buyAmount:d}=t.quote;return me.fromRawAmount(o,d).multiply(r).quotient.toString()},[n,r,o,a,t]);return m.useMemo(()=>{!o||!t||!u||s({amount:{isTyped:!1,value:u},currency:o,field:M.OUTPUT})},[o,t,s,u]),null}function ca(){const{inputPartAmount:e}=A(W);return ur(e),null}function da(){const{search:e,pathname:t}=$e(),n=Je(),r=m.useMemo(()=>new URLSearchParams(e),[e]),{onUserInput:a}=Re(),s=m.useCallback(()=>{const o=new URLSearchParams(e);o.delete(de),o.delete(mn),n({pathname:t,search:o.toString()},{replace:!0})},[n,t,e]);m.useLayoutEffect(()=>{const o=fn(r.get(de));o&&+o>=0&&a(M.INPUT,o),s()},[r,a,s])}function la(){return da(),null}const pa="0d0d9800",ma=10,fa=100;async function We(e,t,n,r,a=[]){const s=await Aa(e,t,r),o=s?.results||[],u=Ta(e,n,o);return a.push(u),a.length>=ma||!s?.next?a.flat():We(e,t,n,s.next,a)}async function Aa(e,t,n){if(n)try{const r=await fetch(n).then(a=>a.json());return await An(fa),r}catch(r){return console.error("Error fetching Safe transactions",{safeAddress:e,nextUrl:n},r),{results:[],count:0}}return t.getAllTransactions(e)}function Ta(e,t,n){return n.map(r=>{if(!r.data||!Sa(r))return null;const a=r.data.indexOf(pa);if(a<0)return null;const s="0x"+r.data.substring(a),o=ba(e,t,s);if(!o)return null;const u=Oa(r);return{conditionalOrderParams:o,safeTxParams:u}}).filter(he)}function Sa(e){return!!e.data&&!!e.submissionDate}function ba(e,t,n){try{const r=t.interface.decodeFunctionData("createWithContext",n),{params:a}=r;return{handler:a.handler,salt:a.salt,staticInput:a.staticInput}}catch{return null}}function Oa(e){const{isExecuted:t,submissionDate:n,executionDate:r,nonce:a,confirmationsRequired:s,confirmations:o,safeTxHash:u}=e;return{isExecuted:t,submissionDate:n,executionDate:r,confirmationsRequired:s,confirmations:o?.length||0,safeTxHash:u,nonce:a}}const xa=15e3;function ga({safeAddress:e,composableCowContract:t}){const n=Tn(),[r,a]=m.useState([]);return m.useEffect(()=>{if(!n)return;const s=()=>{We(e,n,t).then(a)},o=setInterval(s,xa);return s(),()=>clearInterval(o)},[e,n,t]),r}const Pa={gasRequired:185e3,blocksPerFetch:5};function Ca(e,t,n){const r=m.useMemo(()=>n.map(({id:s})=>[e,s]),[e,n]),a=Sn(t,"singleOrders",r,Pa);return m.useMemo(()=>{const s=a.filter(o=>!o.loading&&o.valid);return s.length!==n.length?null:n.reduce((o,u,c)=>(o[u.id]=s[c].result?.[0],o),{})},[n,a])}function wa(e){const{chainId:t}=C(),n=A(bn),{sets:r,ids:a}=m.useMemo(()=>Object.keys(n).reduce((u,c)=>{const{sets:d,ids:l}=u,p=(n[c]||[]).map(f=>f.uid);return d[c]=new Set(p),l.push(...p),u},{sets:{},ids:[]}),[n]),s=On({chainId:t,ids:a}),o=m.useMemo(()=>s?Object.values(s):[],[s]);return m.useMemo(()=>e.reduce((u,c)=>{const d=c.id,l=r[d];if(l?.size>0){const p=o.filter(b=>l.has(b.id)),f=Q(p,"executedBuyAmount").toString(),T=Q(p,"executedSellAmount").toString(),O=Q(p,"executedFeeAmount").toString(),x=ya(c,p);u[d]={info:{executedSellAmount:T,executedFeeAmount:O,executedBuyAmount:f},confirmedPartsCount:x}}else u[d]={info:xe,confirmedPartsCount:0};return u},{}),[e,r,o])}function Q(e,t){return e.reduce((n,r)=>n+BigInt(r.apiAdditionalInfo?.[t]||"0"),BigInt(0))}function ya(e,t){const{executionDate:n}=e.safeData.safeTxParams,{t:r,n:a}=e.orderStruct;if(!n)return 0;const s=Math.ceil(Date.now()/1e3),o=Math.ceil(new Date(n).getTime()/1e3),u=s-o,c=Math.floor(u/r),l=t.filter(f=>xn(f)).reduce((f,{validTo:T})=>T>f?T:f,0);if(!l)return c;const p=Math.ceil((l-o)/r);return Math.min(Math.max(p,c),a)}function ha(e,t){return t===(BigInt(e.partSellAmount)*BigInt(e.n)).toString()}function Ea(e,t,n,r,{confirmedPartsCount:a,info:s}){const o=ha(e,s.executedSellAmount),u=r===!1,c=a===e.n||Ne(e,n);return o?P.Fulfilled:u?P.Cancelled:c?P.Expired:t?P.Pending:P.WaitSigning}function Ne(e,t){if(!t)return!1;const n=Math.ceil(t.getTime()/1e3),{n:r,t:a}=e,s=n+a*r;return Math.ceil(Date.now()/1e3)>s}const Ia=[{name:"sellToken",type:"address"},{name:"buyToken",type:"address"},{name:"receiver",type:"address"},{name:"partSellAmount",type:"uint256"},{name:"minPartLimit",type:"uint256"},{name:"t0",type:"uint256"},{name:"n",type:"uint256"},{name:"t",type:"uint256"},{name:"span",type:"uint256"},{name:"appData",type:"bytes32"}];function Be(e){const t=G.decode(Ia,e);return{sellToken:t.sellToken,buyToken:t.buyToken,receiver:t.receiver,partSellAmount:t.partSellAmount.toHexString(),minPartLimit:t.minPartLimit.toHexString(),t0:t.t0.toNumber(),n:t.n.toNumber(),t:t.t.toNumber(),span:t.span.toNumber(),appData:t.appData}}function Da(e,t,n,r,a){return n.reduce((s,{safeData:o,id:u})=>(s[u]=va(e,t,o,u,r[u],a[u]),s),{})}function va(e,t,n,r,a,s){const{conditionalOrderParams:o,safeTxParams:u}=n,{isExecuted:c,submissionDate:d,executionDate:l}=u,p=l?new Date(l):null,f=Be(o.staticInput),T=Ea(f,c,p,a,s);return{order:f,status:T,chainId:e,safeAddress:t,id:r,submissionDate:d,executedDate:l||void 0,safeTxParams:u,executionInfo:s}}function Fa(e){const{safeAddress:t,chainId:n,composableCowContract:r}=e,a=A(Z),s=E(gn),o=E(Pn),u=Cn(),c=ga(e),d=u?.nonce,l=m.useRef(a);l.current=a;const p=m.useMemo(()=>La(c),[c]),f=wa(p),T=m.useRef(f);T.current=f;const O=m.useMemo(()=>p.filter(S=>ja(S,l.current[S.id])),[p]),x=Ca(t,r,O),b=m.useMemo(()=>d?p.filter(S=>{const{nonce:w,isExecuted:I}=S.safeData.safeTxParams;return!I&&w<d}).map(S=>S.id):[],[d,p]);return m.useEffect(()=>{if(!x)return;const S=Da(n,t,p,x,T.current);b.forEach(w=>{delete S[w]}),s(S),o(b)},[n,t,p,x,s,b,o]),null}function La(e){return e.reduce((t,n)=>{try{const r={id:Ue(n.conditionalOrderParams),orderStruct:Be(n.conditionalOrderParams.staticInput),safeData:n};t.push(r)}catch{}return t},[])}const Ra=6e4;function ja(e,t){const{isExecuted:n,confirmations:r,executionDate:a}=e.safeData.safeTxParams,s=a?new Date(a):null;return Ne(e.orderStruct,s)||!(n&&r>0)||!s||Date.now()-s.getTime()<Ra?!1:t?wn.includes(t.status):!0}function _a(){const{chainId:e,account:t}=C(),n=Y(),r=Oe(),a=A(ae),s=!!(n&&e&&t&&r);return i.jsxs(i.Fragment,{children:[i.jsx(Jr,{}),i.jsx(ca,{}),i.jsx(yn,{orderClass:"twap",slippage:a}),i.jsx(ua,{}),i.jsx(la,{}),s&&i.jsxs(i.Fragment,{children:[i.jsx(na,{}),i.jsx(ea,{}),i.jsx(aa,{}),i.jsx(Fa,{composableCowContract:r,safeAddress:t,chainId:e})]})]})}function Wa(){const e=hn(),t=En(),{isUnlocked:n}=A(In),r=Zr(),a=Pe(),s=se();if(e===void 0)return null;if(!e)return i.jsx(et,{to:Dn(t,vn.SWAP)});const u={disablePriceImpact:a===V.QuoteErrors||a===V.CurrencyNotSupported||a===V.WrapUnwrapFlow||s===Le.SELL_AMOUNT_TOO_SMALL};return i.jsxs(i.Fragment,{children:[i.jsx(br,{}),i.jsxs(cr,{isUnlocked:n,children:[i.jsx(dr,{children:i.jsx(Sr,{updaters:i.jsx(_a,{}),params:u,children:i.jsx(Nr,{})})}),i.jsx(lr,{children:i.jsx(pr,{displayOrdersOnlyForSafeApp:!0,orderType:mr.ADVANCED,orders:r})})]})]})}export{Wa as default};
