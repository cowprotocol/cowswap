name: PR comments

on:
  issue_comment:
    types: edited

env:
  APP_NAME: Cosmos ðŸŒƒ
  APP_PATH: /cosmos/

jobs:
  summary_debug:
    name: Summary debug
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo $EVENT >> $GITHUB_STEP_SUMMARY
        env:
          EVENT: ${{ toJSON(github.event) }}
      - run: |
          echo ${{ github.event.comment.sender.login }}

  pr_commented:
    name: PR comment
    if: ${{ github.event.comment.sender.login == 'vercel[bot]' }}
    runs-on: ubuntu-latest
    steps:
      - name: Get new body
        id: getBody
        uses: actions/github-script@v6
        with:
          script: |
            const body = context.payload.comment.body
            const match = body.match(/Preview]\((.*?)\)/)
            const url = match?.[1]

            if (!url) {
              console.log('Couldn\'t get the url from the comment body', { match, body })
              return ''
            }

            const toAppend = `\$1\n\n[**${process.env.APP_NAME}** â†—ï¸Ž](${url}${process.env.APP_PATH})`

            return body.replace(/(vercel\.app\) \| .*? \|)([\s\S]*$)/m, toAppend)
          result-encoding: string

      - name: 'Debug: print body result'
        run: echo "${{ steps.getBody.outputs.result }}"

      - name: Update comment
        if: ${{ steps.getBody.outputs.result != '' }}
        uses: peter-evans/create-or-update-comment@v2
        with:
          comment-id: ${{ github.event.comment.id }}
          body: ${{ steps.getBody.outputs.result }}
          reactions: eyes
          edit-mode: replace
