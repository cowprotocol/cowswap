name: Release Please

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: lts/jod

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      releases_created: ${{ steps.release.outputs.releases_created }}
    steps:
      # 1️⃣ Run release-please
      - name: Run release-please
        uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38 # v4.4.0
        id: release
        with:
          token: ${{ secrets.RELEASE_PLEASE_AUTH }}
          target-branch: main
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  publish:
    runs-on: ubuntu-latest
    needs: release-please
    if: needs.release-please.outputs.releases_created == 'true'
    steps:
      # 1️⃣ Checkout the repo
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      # 2️⃣ Setup pnpm
      - name: Install pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

      # 3️⃣ Setup Node
      - name: Set up node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      # 4️⃣ Install dependencies
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # 5️⃣ Get publishable libs from nx.json
      - name: Get publishable libs
        id: get-libs
        run: |
          # Extract lib names from nx.json release.projects (e.g., "libs/events" -> "events")
          # Output comma-separated for nx commands, space-separated for bash loops
          LIBS_CSV=$(node -e "const nx = require('./nx.json'); console.log(nx.release.projects.map(p => p.replace('libs/', '')).join(','))")
          LIBS_SPACE=$(node -e "const nx = require('./nx.json'); console.log(nx.release.projects.map(p => p.replace('libs/', '')).join(' '))")
          echo "libs_csv=$LIBS_CSV" >> $GITHUB_OUTPUT
          echo "libs_space=$LIBS_SPACE" >> $GITHUB_OUTPUT

      # 6️⃣ Build publishable libs
      - name: Build publishable libs
        run: pnpm exec nx run-many --target=build --projects=${{ steps.get-libs.outputs.libs_csv }} --parallel

      # 7️⃣ Prepare packages for publishing (apply publishConfig, resolve workspace:*)
      - name: Prepare packages for publishing
        run: |
          for lib in ${{ steps.get-libs.outputs.libs_space }}; do
            if [ -d "dist/libs/$lib" ]; then
              echo "Preparing $lib for publishing..."
              cp "libs/$lib/README.md" "dist/libs/$lib/" 2>/dev/null || true
              node tools/scripts/prepare-publish.mjs "dist/libs/$lib/package.json"
            fi
          done

      # 8️⃣ Setup npm auth
      - name: Setup npm auth
        run: echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      # 9️⃣ Publish released packages
      - name: Publish released packages
        run: pnpm exec nx release publish --tag latest --access public
